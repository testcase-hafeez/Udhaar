<script type="module">
    // IMPORTANT: Make sure your Firebase configuration is correct here.
    const firebaseConfig = {
        apiKey: "AIzaSyBntL44hTWPxWbTLuQJrhx9uvLinIGnT3I",
        authDomain: "kirana-app-32b71.firebaseapp.com",
        projectId: "kirana-app-32b71",
        storageBucket: "kirana-app-32b71.firebasestorage.app",
        messagingSenderId: "915200549911",
        appId: "1:915200549911:web:4b8b84e9e37c67acf22852"
    };

    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, serverTimestamp, orderBy, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    dayjs.extend(dayjs_plugin_relativeTime);

    // --- App State ---
    let currentUser = null;
    let userData = null;
    let unsubscribeListeners = [];
    let myChart = null;

    // --- Utility Functions ---
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    const showPage = (pageId) => {
        $$('.page').forEach(p => p.classList.remove('active'));
        $(`#${pageId}`).classList.add('active');
    };
    const showToast = (message, type = 'success') => {
        const toast = $('#toast');
        toast.textContent = message;
        toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg text-white font-semibold z-50 transition-opacity duration-300 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
        toast.style.opacity = 1;
        setTimeout(() => {
            toast.style.opacity = 0;
        }, 3000);
    };
    const formatCurrency = (amount) => `â‚¹${Number(amount || 0).toFixed(2)}`;
    const formatDate = (timestamp) => timestamp ? dayjs(timestamp.toDate()).format('D MMM YYYY, h:mm A') : '...';
    const timeAgo = (timestamp) => timestamp ? dayjs(timestamp.toDate()).fromNow() : '...';

    const showModal = (html) => {
        $('#modal-container').innerHTML = html;
        const modalBackdrop = $('#modal-container').querySelector('.modal-backdrop');
        const modalContent = $('#modal-container').querySelector('.modal-content');
        setTimeout(() => {
            if(modalBackdrop) modalBackdrop.style.opacity = 1;
            if(modalContent) {
                modalContent.style.opacity = 1;
                modalContent.style.transform = 'translateY(0)';
            }
        }, 10);
    };

    const hideModal = () => {
        const modalBackdrop = $('#modal-container').querySelector('.modal-backdrop');
        const modalContent = $('#modal-container').querySelector('.modal-content');
        if(modalBackdrop) modalBackdrop.style.opacity = 0;
        if(modalContent) {
            modalContent.style.opacity = 0;
            modalContent.style.transform = 'translateY(20px)';
        }
        setTimeout(() => {
            $('#modal-container').innerHTML = '';
        }, 300);
    };


    // --- App Initialization ---
    const init = () => {
        $('#loading-screen').style.display = 'flex';
        onAuthStateChanged(auth, async (user) => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    userData = userDoc.data();
                    if (userData.role === 'shopkeeper') {
                        renderShopkeeperShell();
                    } else {
                        renderCustomerShell();
                    }
                } else {
                    renderOnboarding();
                }
            } else {
                currentUser = null;
                userData = null;
                await signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
                renderOnboarding();
            }
            $('#loading-screen').style.display = 'none';
        });

        // Global modal close listener
        document.addEventListener('click', (e) => {
            if (e.target.matches('.modal-close-btn')) {
                hideModal();
            }
        });
    };

    // --- Onboarding & Authentication ---
    const renderOnboarding = () => {
        $('#onboarding-page').innerHTML = `
            <div class="text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-indigo-600 mb-4"><path d="M2 6h4"/><path d="M2 10h4"/><path d="M2 14h4"/><path d="M2 18h4"/><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M15 2v20"/><path d="M15 7h5"/><path d="M15 12h5"/><path d="M15 17h5"/></svg>
                <h1 class="text-3xl font-bold text-gray-800">Welcome to KiranaCredit</h1>
                <p class="text-gray-600 mt-2 mb-8">The smart ledger for India's MSMEs.</p>
            </div>
            <div class="w-full">
                <h2 class="text-lg font-semibold text-center mb-4">Choose your role to begin:</h2>
                <div class="space-y-4">
                    <button id="select-shopkeeper-btn" class="w-full text-left flex items-center gap-4 p-4 border border-gray-300 rounded-lg hover:bg-indigo-50 hover:border-indigo-500 transition-all">
                        <div class="p-3 bg-indigo-100 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-store text-indigo-600"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M12 7v3a1 1 0 0 1-1 1H0"/></svg></div>
                        <div><p class="font-bold text-lg">I am a Shopkeeper</p><p class="text-sm text-gray-500">Manage your customer ledgers.</p></div>
                    </button>
                    <button id="select-customer-btn" class="w-full text-left flex items-center gap-4 p-4 border border-gray-300 rounded-lg hover:bg-green-50 hover:border-green-500 transition-all">
                        <div class="p-3 bg-green-100 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user text-green-600"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                        <div><p class="font-bold text-lg">I am a Customer</p><p class="text-sm text-gray-500">Add credit to your local shop.</p></div>
                    </button>
                </div>
            </div>`;
        showPage('onboarding-page');
        $('#select-shopkeeper-btn')?.addEventListener('click', () => renderRegistrationForm('shopkeeper'));
        $('#select-customer-btn')?.addEventListener('click', () => renderRegistrationForm('customer'));
    };

    const renderRegistrationForm = (role) => {
        const isShopkeeper = role === 'shopkeeper';
        $('#onboarding-page').innerHTML = `
            <div class="w-full">
                <button id="back-to-onboarding" class="mb-6 text-indigo-600 font-semibold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                    Back
                </button>
                <h2 class="text-2xl font-bold mb-2">${isShopkeeper ? 'Shopkeeper Registration' : 'Customer Registration'}</h2>
                <p class="text-gray-600 mb-8">${isShopkeeper ? 'Create your shop profile to start.' : 'Create your profile to manage credit.'}</p>
                <form id="registration-form">
                    <div class="mb-4">
                        <label for="reg-name" class="block text-sm font-medium text-gray-700 mb-1">Your Full Name ${isShopkeeper ? ' (or Shop Name)' : ''}</label>
                        <input type="text" id="reg-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-6">
                        <label for="reg-phone" class="block text-sm font-medium text-gray-700 mb-1">Your 10-digit Phone Number</label>
                        <input type="tel" id="reg-phone" required pattern="\\d{10}" title="Please enter a 10-digit phone number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">This will be your unique ID.</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-105">Complete Registration</button>
                </form>
            </div>
        `;
        $('#back-to-onboarding').addEventListener('click', renderOnboarding);
        $('#registration-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = $('#reg-name').value.trim();
            const phone = $('#reg-phone').value.trim();
            const userRef = doc(db, "users", currentUser.uid);
            await setDoc(userRef, { name, phone, role, createdAt: serverTimestamp() });
            userData = { name, phone, role }; // Manually update state to prevent re-fetch
            if (role === 'shopkeeper') renderShopkeeperShell();
            else renderCustomerShell();
        });
    };

    // --- Shopkeeper Logic ---
    const renderShopkeeperShell = () => {
        showPage('shopkeeper-main-page');
        handleShopkeeperNav('shopkeeper-dashboard');
        $$('#shopkeeper-main-page .nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const target = e.currentTarget.dataset.target;
                if(target) handleShopkeeperNav(target);
            });
        });
        $('#logout-btn').addEventListener('click', () => signOut(auth));
    };

    const handleShopkeeperNav = (target) => {
        $$('#shopkeeper-main-page .nav-btn').forEach(b => b.classList.remove('active'));
        $(`button[data-target='${target}']`).classList.add('active');
        if(target === 'shopkeeper-dashboard') renderShopkeeperDashboard();
        if(target === 'shopkeeper-analytics') renderShopkeeperAnalytics();
    };

    const renderShopkeeperDashboard = () => {
        $('#shopkeeper-content').innerHTML = `
            <header class="bg-indigo-600 text-white p-4 sticky top-0 z-10 shadow-md">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold">${userData.name}</h1>
                        <p class="text-sm text-indigo-200">Shopkeeper Dashboard</p>
                    </div>
                    <button id="show-qr-btn" class="p-2 rounded-full bg-indigo-500 hover:bg-indigo-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h.01"/><path d="M21 12h.01"/><path d="M12 21h.01"/></svg>
                    </button>
                </div>
            </header>
            <div class="p-4 bg-gray-100">
                <div id="summary-cards" class="grid grid-cols-2 gap-4 mb-4"></div>
                <input type="text" id="search-bar" placeholder="Search customer..." class="w-full px-4 py-2 border rounded-lg mb-4">
                <div id="customer-list" class="space-y-3"></div>
            </div>`;

        $('#show-qr-btn').addEventListener('click', () => {
            const shopId = userData.phone;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent('kiranacredit:shopid=' + shopId)}`;
            showModal(`...QR code modal HTML...`);
        });

        const q = query(collection(db, `users/${currentUser.uid}/customers`), orderBy("lastActivity", "desc"));
        const unsub = onSnapshot(q, (snapshot) => {
            let customers = [];
            snapshot.forEach(doc => customers.push({ id: doc.id, ...doc.data() }));
            
            // Render summary cards
            const totalDue = customers.reduce((sum, c) => sum + c.totalDue, 0);
            $('#summary-cards').innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-gray-500">Total Outstanding</p><p class="text-2xl font-bold text-red-600">${formatCurrency(totalDue)}</p></div>
                <div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-gray-500">Active Customers</p><p class="text-2xl font-bold">${customers.length}</p></div>
            `;
            
            // Render customer list
            const listEl = $('#customer-list');
            if (customers.length === 0) {
                listEl.innerHTML = `<div class="text-center py-10 text-gray-500"><p>No customers yet.</p><p class="text-sm">Share your QR code to get started.</p></div>`;
                return;
            }
            listEl.innerHTML = customers.map(c => `
                <div class="customer-card flex items-center justify-between p-4 bg-white rounded-lg shadow-sm hover:shadow-md cursor-pointer" data-id="${c.id}" data-name="${c.name}">
                    <div><p class="font-bold">${c.name}</p><p class="text-sm text-gray-500">Last active: ${timeAgo(c.lastActivity)}</p></div>
                    <div><p class="font-bold text-lg text-right ${c.totalDue > 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(c.totalDue)}</p></div>
                </div>
            `).join('');

            $$('.customer-card').forEach(card => card.addEventListener('click', (e) => {
                renderLedgerDetail('shopkeeper', e.currentTarget.dataset.id, e.currentTarget.dataset.name);
            }));
        });
        unsubscribeListeners.push(unsub);
    };

    // --- Customer Logic ---
    const renderCustomerShell = () => {
        showPage('customer-main-page');
        handleCustomerNav('customer-dashboard');
        $$('#customer-main-page .nav-btn').forEach(btn => {
             btn.addEventListener('click', (e) => {
                const target = e.currentTarget.dataset.target;
                if(target) handleCustomerNav(target);
            });
        });
        $('#customer-logout-btn').addEventListener('click', () => signOut(auth));
    };
    
    const handleCustomerNav = (target) => {
        $$('#customer-main-page .nav-btn').forEach(b => b.classList.remove('active'));
        $(`button[data-target='${target}']`).classList.add('active');
        if(target === 'customer-dashboard') renderCustomerDashboard();
    };

    const renderCustomerDashboard = () => {
        $('#customer-content').innerHTML = `
            <header class="bg-green-600 text-white p-4">
                <h1 class="text-xl font-bold">Welcome, ${userData.name}</h1>
                <p class="text-sm text-green-200">Your Ledgers</p>
            </header>
            <div class="p-4">
                <div id="shop-list" class="space-y-3"></div>
            </div>
            <div class="fixed bottom-20 right-4">
                <button id="add-credit-btn" class="bg-green-600 text-white rounded-full p-4 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                </button>
            </div>
        `;

        $('#add-credit-btn').addEventListener('click', () => {
            showModal(`...Add credit modal HTML...`);
            // Add form submission logic inside modal
        });
        
        // Query for shops where this user is a customer
        const q = query(collection(db, "users"), where("role", "==", "shopkeeper"));
        const unsub = onSnapshot(q, async (snapshot) => {
            // ... Logic to find and display shops ...
        });
        unsubscribeListeners.push(unsub);
    };
    
    // --- Other rendering functions (Analytics, LedgerDetail, etc.) ---
    const renderShopkeeperAnalytics = () => { /* ... Analytics HTML and Chart.js logic ... */ };
    const renderLedgerDetail = (role, id, name) => { /* ... Ledger detail HTML and logic ... */ };


    // --- Start the App ---
    init();
</script>
